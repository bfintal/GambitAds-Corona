-- GambitAds v0.1
local c={}c.appKey=nil;c.token=nil;c.adLoaded=false;c.gambitAdAPI="http://ads.api.gambit.ph/"c.gambitAdAPIGetAdToDisplay="getAdToDisplay.php"c.gambitAdAPIAdClicked="adClicked.php"c.gambitAdAPIAdCanceled="adCanceled.php"c.gambitAdAssets="gambitads_assets/"c.adTempName="gambitad.jpg"c.adData=nil;c.adWindowGroup=nil;c.adWindowRect=nil;c.adWindowFade=nil;c._orientationChanged=function(d)c.adWindowFade.width,c.adWindowFade.height=display.contentWidth,display.contentHeight;c.adWindowGroup.x,c.adWindowGroup.y=display.contentWidth/2,display.contentHeight/2;if string.find(d.type,"portrait")~=nil then else end end;c._generateHash=function()local e="DEBUG"if system.getInfo("environment")~="simulator"then e=system.getInfo("deviceID")..os.time()else print("GAMBITADS IS RUNNING IN THE SIMULATOR AND IN DEBUG MODE. TEST ADS WILL SHOW UP.")end;local f=require"crypto"return f.hmac(f.md5,e,c.appKey)end;c.preloadAd=function()assert(c.appKey,"You must initialize gambitAd first")c.adLoaded=false;local g=c._generateHash()local function h(d)if d.isError then Runtime:dispatchEvent({name="gambitAd-AdNotPreloaded"})if d.status==404 then assert(false,"GambitAds: App Key is invalid")elseif d.status==403 then assert(false,"GambitAds: Hash is invalid")elseif d.status==422 then assert(false,"GambitAds: Missing parameters")else assert(false,"GambitAds: Something else went wong. Got error status: "..d.status)end else if d.response~=""then local i=require"json"local j=i.decode(d.response)c.adLoaded=true;c.token=j["token"]c.adData=j;Runtime:dispatchEvent({name="gambitAd-AdPreloaded"})else Runtime:dispatchEvent({name="gambitAd-AdLoadingError"})end end end;network.request(c.gambitAdAPI..c.gambitAdAPIGetAdToDisplay.."?appKey="..c.appKey.."&hash="..g.."&deviceID="..system.getInfo("deviceID"),"GET",h)end;c.init=function(k)c.appKey=k;Runtime:addEventListener("orientation",c._orientationChanged)c.preloadAd()end;c._adImageTransition=nil;c._adImageLoaded=function(d)local l;l=display.newImageRect(c.adTempName,system.DocumentsDirectory,300,300)l.alpha=0;l.x,l.y=c.adWindowRect.x-c.adWindowRect.width/2+l.width/2,c.adWindowRect.y;c.adWindowGroup:insert(l)c._adImageTransition=transition.to(l,{time=200,alpha=1,onComplete=function()if c._adImageTransition then c._adImageTransition=nil end end})end;c._showAdTransition=nil;c._removeAdTransition=nil;c._removeAd=function()c._removeAdTransition=transition.to(c.adWindowGroup,{time=400,alpha=0,onComplete=function()if c._removeAdTransition then c._removeAdTransition=nil end;local m=display.getCurrentStage()if c._adImageTransition then transition.cancel(c._adImageTransition)c._adImageTransition=nil end;if c._showAdTransition then transition.cancel(c._showAdTransition)c._showAdTransition=nil end;if c.adWindowGroup then c.adWindowGroup:removeSelf()c.adWindowGroup=nil end end})c.adLoaded=false end;c.showAd=function()assert(c.appKey,"You must initialize gambitAd first")if c.adLoaded==false then return end;if c.adWindowGroup then return end;local n=require("widget")local m=display.getCurrentStage()local o=display.newGroup()c.adWindowGroup=o;c.adWindowGroup.alpha=0;local l;local p;local q=display.contentWidth;local s=display.contentHeight;local t=300;local u=600;l=display.newRect(-q/2,-s/2,q,s)l:setFillColor(0,0,0,150)o:insert(l)c.adWindowFade=l;l=display.newRect(-u/2,-t/2,u,t)l:setFillColor(36,36,36)p=l;o:insert(l)c.adWindowRect=l;c.adWindowFade.width,c.adWindowFade.height=q,s;c.adWindowGroup.x,c.adWindowGroup.y=q/2,s/2;local v={highlight={r=20,l=20,b=20,a=255},shadow={r=20,l=20,b=20,a=255}}l=display.newImageRect(c.gambitAdAssets.."ad_wndw_t.png",u,78)l.x,l.y=c.adWindowRect.x,c.adWindowRect.y-c.adWindowRect.height/2-l.height/2;o:insert(l)p=l;l=display.newText(c.adData["title"],0,0,native.systemFont,26)l.x,l.y=p.x-p.width/2+l.width/2+20,p.y;o:insert(l)local l=n.newButton{width=78,height=78,defaultFile=c.gambitAdAssets.."ad_close.png",overFile=c.gambitAdAssets.."ad_close.png",id="close",label="",onEvent=function(d)if d.phase=="ended"then c._removeAd()Runtime:dispatchEvent({name="gambitAd-AdRemoved"})c.preloadAd()end end}l.x,l.y=p.x+p.width/2-l.width/2,p.y;o:insert(l)l=display.newImageRect(c.gambitAdAssets.."ad_wndw_b.png",u,38)l.x,l.y=c.adWindowRect.x,c.adWindowRect.y+c.adWindowRect.height/2+l.height/2;o:insert(l)p=l;l=display.newImageRect(c.gambitAdAssets.."ad_footer.png",154,38)l.x,l.y=p.x-p.width/2+l.width/2+20,p.y;o:insert(l)l=display.newText(c.adData["name"],0,0,native.systemFont,22)l.x,l.y=c.adWindowRect.x+l.width/2+30,c.adWindowRect.y-100;o:insert(l)l=display.newText(c.adData["desc"],0,0,u/2-30*2,115,native.systemFont,18)l:setTextColor(255)l.x,l.y=c.adWindowRect.x+l.width/2+30,c.adWindowRect.y;o:insert(l)local l=n.newButton{width=214,height=53,defaultFile=c.gambitAdAssets.."ad_button.png",overFile=c.gambitAdAssets.."ad_button.png",id="go",label="",onEvent=function(d)if d.phase=="ended"then c._clickAd()c.preloadAd()end end}l.x,l.y=c.adWindowRect.x+c.adWindowRect.width/4,c.adWindowRect.y+c.adWindowRect.height/2-l.height/2-20;o:insert(l)p=l;l=display.newEmbossedText(c.adData["button"],0,0,native.systemFont,20,{0,0,0,255})l:setEmbossColor(v)l:setTextColor(255)l.x,l.y=p.x,p.y;o:insert(l)network.download(c.adData["image"],"GET",c._adImageLoaded,c.adTempName,system.DocumentsDirectory)c._showAdTransition=transition.to(c.adWindowGroup,{time=400,alpha=1,onComplete=function()if c._showAdTransition then c._showAdTransition=nil end end})m:insert(o)end;c.cancelAd=function()assert(c.appKey,"You must initialize gambitAd first")assert(c.token,"Ad data has not been loaded yet. Use the property adLoaded to check if an ad has been loaded.")local g=c._generateHash()local function h(d)if d.isError then Runtime:dispatchEvent({name="gambitAd-AdNotCanceled"})if d.status==404 then assert(false,"GambitAds: App Key is invalid")elseif d.status==403 then assert(false,"GambitAds: Token is no longer valid or is malformed")elseif d.status==422 then assert(false,"GambitAds: Missing parameters")else assert(false,"GambitAds: Something else went wong. Got error status: "..d.status)end else Runtime:dispatchEvent({name="gambitAd-AdCanceled"})c.token=nil;c.adLoaded=false;c.adData=false end end;c._removeAd()network.request(c.gambitAdAPI..c.gambitAdAPIAdCanceled.."?appKey="..c.appKey.."&token="..c.token,"GET",h)end;c._clickAd=function()assert(c.appKey,"You must initialize gambitAd first")assert(c.token,"Ad data has not been loaded yet. Use the property adLoaded to check if an ad has been loaded.")system.openURL(c.gambitAdAPI..c.gambitAdAPIAdClicked.."?appKey="..c.appKey.."&token="..c.token)c._removeAd()end;return c